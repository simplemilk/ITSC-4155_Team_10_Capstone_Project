{% extends 'base.html' %}

{% block title %}Password Recovery - Niner Finance{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <!-- Header -->
        <div class="auth-header">
            <h2><i class="fas fa-key me-2"></i>Password Recovery</h2>
            <p>Answer your security questions to reset your password</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'info-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% if step == 1 %}
        <!-- Step 1: Enter Username/Email -->
        <form method="POST" action="{{ url_for('auth.forgot_password_questions') }}">
            <input type="hidden" name="step" value="1">
            
            <div class="form-floating mb-3">
                <input type="text" 
                       class="form-control" 
                       id="identifier" 
                       name="identifier" 
                       placeholder="Username or Email" 
                       required>
                <label for="identifier"><i class="fas fa-user me-2"></i>Username or Email</label>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-3">
                <i class="fas fa-arrow-right me-2"></i>Continue
            </button>
        </form>

        {% elif step == 2 %}
        <!-- Step 2: Answer Security Questions -->
        <div class="security-questions-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Please answer both security questions to reset your password.
            </div>

            <form method="POST" action="{{ url_for('auth.forgot_password_questions') }}">
                <input type="hidden" name="step" value="2">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                
                <!-- Security Question 1 -->
                <div class="question-group mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-question-circle me-2"></i>{{ user.security_question_1 }}
                    </label>
                    <input type="text" 
                           class="form-control" 
                           name="answer1" 
                           placeholder="Your answer" 
                           required>
                </div>

                <!-- Security Question 2 -->
                <div class="question-group mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-question-circle me-2"></i>{{ user.security_question_2 }}
                    </label>
                    <input type="text" 
                           class="form-control" 
                           name="answer2" 
                           placeholder="Your answer" 
                           required>
                </div>

                <!-- New Password -->
                <div class="form-floating mb-3">
                    <input type="password" 
                           class="form-control" 
                           id="newPassword" 
                           name="newPassword" 
                           placeholder="New Password" 
                           required>
                    <label for="newPassword"><i class="fas fa-lock me-2"></i>New Password</label>
                </div>

                <!-- Confirm Password -->
                <div class="form-floating mb-3">
                    <input type="password" 
                           class="form-control" 
                           id="confirmPassword" 
                           name="confirmPassword" 
                           placeholder="Confirm New Password" 
                           required>
                    <label for="confirmPassword"><i class="fas fa-lock me-2"></i>Confirm New Password</label>
                </div>

                <button type="submit" class="btn btn-success w-100 mb-3">
                    <i class="fas fa-check me-2"></i>Reset Password
                </button>
            </form>
        </div>
        {% endif %}

        <!-- Back to Login -->
        <div class="auth-link">
            <a href="{{ url_for('auth.login') }}">
                <i class="fas fa-arrow-left me-2"></i>Back to Login
            </a>
        </div>
    </div>
</div>

<style>
.security-questions-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.question-group {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.question-group label {
    color: #355E3B;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}