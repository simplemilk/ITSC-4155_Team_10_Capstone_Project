{% extends 'base.html' %}

{% block title %}Register - Niner Finance{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<div class="auth-container register-container">
    <div class="auth-card register-card">
        <!-- Flash Messages -->
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'info-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Auth Header -->
        <div class="auth-header register-header">
            <h2><i class="fas fa-user-plus me-2"></i>Create Account</h2>
            <p>Join Niner Finance to manage your finances</p>
        </div>

        <!-- Registration Form -->
        <form id="registerForm" method="POST" action="{{ url_for('auth.register') }}" novalidate>
            <!-- Basic Info Section -->
            <div class="form-section">
                <h5><i class="fas fa-user me-2"></i>Account Information</h5>
                
                <!-- Username Field -->
                <div class="form-floating mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="username" 
                           name="username" 
                           placeholder="Username" 
                           required
                           minlength="3"
                           pattern="[a-zA-Z0-9_]+"
                           value="{{ request.form['username'] if request.form else '' }}">
                    <label for="username"><i class="fas fa-user me-2"></i>Username</label>
                    <div class="invalid-feedback">
                        Please choose a username (at least 3 characters, letters, numbers, and underscores only).
                    </div>
                    <div class="valid-feedback">
                        Username looks good!
                    </div>
                </div>

                <!-- Email Field -->
                <div class="form-floating mb-3">
                    <input type="email" 
                           class="form-control" 
                           id="email" 
                           name="email" 
                           placeholder="Email" 
                           required
                           value="{{ request.form['email'] if request.form else '' }}">
                    <label for="email"><i class="fas fa-envelope me-2"></i>Email</label>
                    <div class="invalid-feedback">
                        Please enter a valid email address.
                    </div>
                    <div class="valid-feedback">
                        Email looks good!
                    </div>
                </div>

                <!-- Password Field -->
                <div class="form-floating mb-3 position-relative">
                    <input type="password" 
                           class="form-control" 
                           id="password" 
                           name="password" 
                           placeholder="Password" 
                           required
                           minlength="8">
                    <label for="password"><i class="fas fa-lock me-2"></i>Password</label>
                    <button type="button" 
                            class="password-toggle" 
                            onclick="togglePassword('password')" 
                            tabindex="-1"
                            aria-label="Toggle password visibility">
                        <i class="fas fa-eye" id="passwordToggleIcon"></i>
                    </button>
                    <div class="invalid-feedback">
                        Password must be at least 8 characters long.
                    </div>
                    <div class="valid-feedback">
                        Password strength looks good!
                    </div>
                </div>

                <!-- Confirm Password Field -->
                <div class="form-floating mb-3 position-relative">
                    <input type="password" 
                           class="form-control" 
                           id="confirmPassword" 
                           name="confirmPassword" 
                           placeholder="Confirm Password" 
                           required
                           minlength="8">
                    <label for="confirmPassword"><i class="fas fa-lock me-2"></i>Confirm Password</label>
                    <button type="button" 
                            class="password-toggle" 
                            onclick="togglePassword('confirmPassword')" 
                            tabindex="-1"
                            aria-label="Toggle password visibility">
                        <i class="fas fa-eye" id="confirmPasswordToggleIcon"></i>
                    </button>
                    <div class="invalid-feedback">
                        Passwords must match.
                    </div>
                    <div class="valid-feedback">
                        Passwords match!
                    </div>
                </div>

                <!-- Password Requirements Indicator -->
                <div class="password-requirements">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Password must be at least 8 characters long
                    </small>
                </div>
            </div>

            <!-- Security Questions Section -->
            <div class="form-section">
                <h5><i class="fas fa-shield-alt me-2"></i>Security Questions</h5>
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Security questions help you recover your password if you forget it. Choose questions only you would know the answer to.
                </p>
                
                <!-- Security Question 1 -->
                <div class="mb-3">
                    <label for="securityQuestion1" class="form-label">
                        <i class="fas fa-question-circle me-2"></i>Security Question 1
                    </label>
                    <select class="form-select" 
                            id="securityQuestion1" 
                            name="securityQuestion1" 
                            required>
                        <option value="">Choose your first security question...</option>
                        <option value="What was the name of your first pet?" 
                                {{ 'selected' if request.form.get('securityQuestion1') == 'What was the name of your first pet?' else '' }}>
                            What was the name of your first pet?
                        </option>
                        <option value="What city were you born in?" 
                                {{ 'selected' if request.form.get('securityQuestion1') == 'What city were you born in?' else '' }}>
                            What city were you born in?
                        </option>
                        <option value="What was your mother's maiden name?" 
                                {{ 'selected' if request.form.get('securityQuestion1') == "What was your mother's maiden name?" else '' }}>
                            What was your mother's maiden name?
                        </option>
                        <option value="What was the name of your first school?" 
                                {{ 'selected' if request.form.get('securityQuestion1') == 'What was the name of your first school?' else '' }}>
                            What was the name of your first school?
                        </option>
                        <option value="What was your favorite food as a child?" 
                                {{ 'selected' if request.form.get('securityQuestion1') == 'What was your favorite food as a child?' else '' }}>
                            What was your favorite food as a child?
                        </option>
                    </select>
                    <div class="invalid-feedback">
                        Please select a security question.
                    </div>
                </div>

                <div class="form-floating mb-4">
                    <input type="text" 
                           class="form-control" 
                           id="securityAnswer1" 
                           name="securityAnswer1" 
                           placeholder="Answer 1" 
                           required
                           minlength="2"
                           autocomplete="off"
                           value="{{ request.form['securityAnswer1'] if request.form else '' }}">
                    <label for="securityAnswer1">
                        <i class="fas fa-key me-2"></i>Answer 1
                    </label>
                    <div class="invalid-feedback">
                        Please provide an answer (at least 2 characters).
                    </div>
                    <div class="valid-feedback">
                        Answer looks good!
                    </div>
                </div>

                <!-- Security Question 2 -->
                <div class="mb-3">
                    <label for="securityQuestion2" class="form-label">
                        <i class="fas fa-question-circle me-2"></i>Security Question 2
                    </label>
                    <select class="form-select" 
                            id="securityQuestion2" 
                            name="securityQuestion2" 
                            required>
                        <option value="">Choose your second security question...</option>
                        <option value="What was the name of your childhood best friend?" 
                                {{ 'selected' if request.form.get('securityQuestion2') == 'What was the name of your childhood best friend?' else '' }}>
                            What was the name of your childhood best friend?
                        </option>
                        <option value="What was the make of your first car?" 
                                {{ 'selected' if request.form.get('securityQuestion2') == 'What was the make of your first car?' else '' }}>
                            What was the make of your first car?
                        </option>
                        <option value="What was your favorite teacher's name?" 
                                {{ 'selected' if request.form.get('securityQuestion2') == "What was your favorite teacher's name?" else '' }}>
                            What was your favorite teacher's name?
                        </option>
                        <option value="What street did you grow up on?" 
                                {{ 'selected' if request.form.get('securityQuestion2') == 'What street did you grow up on?' else '' }}>
                            What street did you grow up on?
                        </option>
                        <option value="What was your first job?" 
                                {{ 'selected' if request.form.get('securityQuestion2') == 'What was your first job?' else '' }}>
                            What was your first job?
                        </option>
                    </select>
                    <div class="invalid-feedback">
                        Please select a second security question.
                    </div>
                </div>

                <div class="form-floating mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="securityAnswer2" 
                           name="securityAnswer2" 
                           placeholder="Answer 2" 
                           required
                           minlength="2"
                           autocomplete="off"
                           value="{{ request.form['securityAnswer2'] if request.form else '' }}">
                    <label for="securityAnswer2">
                        <i class="fas fa-key me-2"></i>Answer 2
                    </label>
                    <div class="invalid-feedback">
                        Please provide an answer (at least 2 characters).
                    </div>
                    <div class="valid-feedback">
                        Answer looks good!
                    </div>
                </div>

                <!-- Security Questions Help -->
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>Tips:</strong> 
                        Choose answers you'll remember but others won't easily guess. 
                        Answers are not case-sensitive.
                    </small>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="form-section">
                <div class="form-check mb-3">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="agreeTerms" 
                           name="agreeTerms" 
                           required
                           {{ 'checked' if request.form.get('agreeTerms') else '' }}>
                    <label class="form-check-label" for="agreeTerms">
                        I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and 
                        <a href="#" class="text-decoration-none">Privacy Policy</a>
                    </label>
                    <div class="invalid-feedback">
                        You must agree to the terms and conditions.
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary w-100 btn-auth btn-register mb-3">
                <i class="fas fa-user-plus me-2"></i>Create Account
            </button>
        </form>

        <!-- Login Link -->
        <div class="auth-link register-link">
            <p>Already have an account?</p>
            <a href="{{ url_for('auth.login') }}">Sign In</a>
        </div>

        <!-- Demo Info -->
        <div class="demo-help mt-3">
            <div class="alert alert-light border">
                <h6><i class="fas fa-info-circle me-2"></i>Demo Account Available</h6>
                <p class="mb-1">For testing, you can use the existing demo account:</p>
                <small>
                    <strong>Username:</strong> demo | 
                    <strong>Password:</strong> demo123
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Auth.js is already loaded globally -->
<script>
// Page-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Register page with security questions loaded');
    
    // Prevent selecting the same question twice
    const question1 = document.getElementById('securityQuestion1');
    const question2 = document.getElementById('securityQuestion2');
    
    function updateQuestionOptions() {
        const selectedQuestion1 = question1.value;
        const selectedQuestion2 = question2.value;
        
        // Enable all options first
        Array.from(question1.options).forEach(option => {
            if (option.value !== '') {
                option.disabled = false;
            }
        });
        Array.from(question2.options).forEach(option => {
            if (option.value !== '') {
                option.disabled = false;
            }
        });
        
        // Disable selected options in the other dropdown
        if (selectedQuestion1) {
            Array.from(question2.options).forEach(option => {
                if (option.value === selectedQuestion1) {
                    option.disabled = true;
                }
            });
        }
        
        if (selectedQuestion2) {
            Array.from(question1.options).forEach(option => {
                if (option.value === selectedQuestion2) {
                    option.disabled = true;
                }
            });
        }
    }
    
    if (question1 && question2) {
        question1.addEventListener('change', updateQuestionOptions);
        question2.addEventListener('change', updateQuestionOptions);
        
        // Run on page load to handle form repopulation
        updateQuestionOptions();
    }
    
    // Add visual feedback for security questions
    const securityAnswers = document.querySelectorAll('[name*="securityAnswer"]');
    securityAnswers.forEach(field => {
        field.addEventListener('input', function() {
            if (this.value.length >= 2) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else if (this.value.length > 0) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
    });
    
    // Security question select validation
    const securityQuestions = document.querySelectorAll('[name*="securityQuestion"]');
    securityQuestions.forEach(field => {
        field.addEventListener('change', function() {
            if (this.value) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            }
        });
    });
});
</script>
{% endblock %}