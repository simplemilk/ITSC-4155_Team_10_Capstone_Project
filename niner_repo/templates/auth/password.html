{% extends 'base.html' %}

{% block title %}Forgot Password - Niner Finance{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/password.css') }}">
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <!-- Flash Messages -->
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if success %}
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>{{ success }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'info-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Auth Header -->
        <div class="auth-header">
            <h2><i class="fas fa-key me-2"></i>Reset Password</h2>
            <p>Enter your username or email address and we'll send you a link to reset your password</p>
        </div>

        <!-- Forgot Password Form -->
        <form id="forgotPasswordForm" method="POST" action="{{ url_for('auth.forgot_password') }}" novalidate>
            <!-- Username or Email Field -->
            <div class="form-floating mb-3">
                <input type="text" 
                       class="form-control" 
                       id="identifier" 
                       name="identifier" 
                       placeholder="Username or Email" 
                       required
                       value="{{ request.form['identifier'] if request.form else '' }}">
                <label for="identifier"><i class="fas fa-user me-2"></i>Username or Email</label>
                <div class="invalid-feedback" id="identifierError">
                    Please enter your username or email address.
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Enter either your username or email address associated with your account.
                </div>
            </div>

            <!-- Security Question (if enabled) -->
            <div class="security-question mb-3" id="securityQuestionDiv" style="display: none;">
                <div class="form-floating">
                    <input type="text" 
                           class="form-control" 
                           id="securityAnswer" 
                           name="securityAnswer" 
                           placeholder="Security Answer">
                    <label for="securityAnswer"><i class="fas fa-shield-alt me-2"></i>Security Answer</label>
                    <div class="invalid-feedback" id="securityAnswerError">
                        Security answer is required.
                    </div>
                </div>
                <div class="form-text security-question-text" id="securityQuestionText">
                    <!-- Security question will be populated here -->
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary w-100 btn-auth" id="submitBtn">
                <i class="fas fa-paper-plane me-2"></i>Send Reset Link
            </button>
        </form>

        <!-- Auth Divider -->
        <div class="auth-divider">
            <span>or</span>
        </div>

        <!-- Alternative Options -->
        <div class="alternative-options">
            <button type="button" class="btn btn-outline-info w-100 mb-2" onclick="showSecurityQuestions()">
                <i class="fas fa-question-circle me-2"></i>Try Security Questions
            </button>
            
            <button type="button" class="btn btn-outline-secondary w-100 mb-3" onclick="contactSupport()">
                <i class="fas fa-life-ring me-2"></i>Contact Support
            </button>
        </div>

        <!-- Back to Login Link -->
        <div class="auth-link">
            <p>Remember your password?</p>
            <a href="{{ url_for('auth.login') }}">
                <i class="fas fa-arrow-left me-1"></i>Back to Login
            </a>
        </div>
    </div>
</div>

<!-- Security Questions Modal -->
<div class="modal fade" id="securityQuestionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt me-2"></i>Security Questions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Answer these security questions to verify your identity:</p>
                
                <form id="securityQuestionsForm">
                    <div class="mb-3">
                        <label class="form-label">What was the name of your first pet?</label>
                        <input type="text" class="form-control" id="question1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">What city were you born in?</label>
                        <input type="text" class="form-control" id="question2" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">What was your childhood nickname?</label>
                        <input type="text" class="form-control" id="question3" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="verifySecurityQuestions()">
                    <i class="fas fa-check me-2"></i>Verify
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Contact Support Modal -->
<div class="modal fade" id="contactSupportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-life-ring me-2"></i>Contact Support
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="support-options">
                    <div class="support-option">
                        <h6><i class="fas fa-envelope me-2"></i>Email Support</h6>
                        <p>Send us an email with your account details:</p>
                        <a href="mailto:support@ninerfinance.com?subject=Password Reset Request" class="btn btn-outline-primary btn-sm">
                            support@ninerfinance.com
                        </a>
                    </div>
                    
                    <hr>
                    
                    <div class="support-option">
                        <h6><i class="fas fa-phone me-2"></i>Phone Support</h6>
                        <p>Call us during business hours (Mon-Fri, 9AM-5PM):</p>
                        <a href="tel:+1-704-687-8622" class="btn btn-outline-success btn-sm">
                            (704) 687-8622
                        </a>
                    </div>
                    
                    <hr>
                    
                    <div class="support-option">
                        <h6><i class="fas fa-comments me-2"></i>Live Chat</h6>
                        <p>Chat with our support team online:</p>
                        <button class="btn btn-outline-info btn-sm" onclick="startLiveChat()">
                            Start Chat
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div class="support-option">
                        <h6><i class="fas fa-university me-2"></i>Campus Support</h6>
                        <p>Visit the IT Help Desk at UNCC:</p>
                        <address>
                            <strong>UNCC IT Help Desk</strong><br>
                            J. Murrey Atkins Library<br>
                            9201 University City Blvd<br>
                            Charlotte, NC 28223
                        </address>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Reset Success Modal -->
<div class="modal fade" id="resetSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Reset Link Sent!
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-envelope-open fa-3x text-success mb-3"></i>
                    <h6>Check Your Email</h6>
                    <p>We've sent a password reset link to your email address.</p>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Didn't receive the email?</strong><br>
                    <small>
                        Check your spam folder or wait a few minutes and try again.
                        The link will expire in 24 hours.
                    </small>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="resendResetEmail()">
                        <i class="fas fa-redo me-2"></i>Resend Email
                    </button>
                    <a href="{{ url_for('auth.login') }}" class="btn btn-success">
                        <i class="fas fa-arrow-left me-2"></i>Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/password.js') }}"></script>
{% endblock %}